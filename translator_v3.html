<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenAI TTS Demo (User API Key + Cache)</title>
<style>
  body {
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    height: 100vh; font-family: sans-serif;
  }
  .toolbar {
    background: #4285F4; color: white;
    padding: 10px; display: flex; gap: 10px; align-items: center;
    position: sticky; top: 0;
  }
  .toolbar button {
    background: white; color: #4285F4; border: none; padding: 6px 10px;
    cursor: pointer; border-radius: 4px;
  }
  .container {
    flex: 1; display: flex; gap: 10px; padding: 10px; box-sizing: border-box;
  }
  textarea {
    flex: 1; resize: none; font-family: monospace; font-size: 16px;
    padding: 10px;
  }
  .preview {
    flex: 1; padding: 10px; background: #f7f7f7; overflow-y: auto;
    font-family: sans-serif; font-size: 16px;
  }
  .sentence {
    display: block; margin-bottom: 6px; cursor: pointer; padding: 2px 4px;
    border-radius: 3px;
  }
  .sentence:hover { background: rgba(66,133,244,0.2); }
  .active { background: rgba(66,133,244,0.4); }
</style>
</head>
<body>
  <div class="toolbar">
    <button onclick="playPrevious()">‚èÆ Play Previous</button>
    <button onclick="playCurrent()">‚ñ∂Ô∏è Play Current</button>
    <button onclick="playNext()">‚è≠ Play Next</button>
    <button onclick="resetApiKey()">üîë Change API Key</button>
  </div>
  <div class="container">
    <textarea id="inputText" placeholder="Type or paste text here..."></textarea>
    <div id="preview" class="preview"></div>
  </div>
<script>
let currentIndex = 0;
let sentences = [];
let cache = {};  // cache: idx -> blob URL

document.addEventListener('DOMContentLoaded', async () => {
  await checkApiKey();
  const textarea = document.getElementById('inputText');
  textarea.addEventListener('input', updatePreview);

  textarea.addEventListener('paste', () => {
    // Wait a short moment for paste to complete
    setTimeout(() => {
      let text = textarea.value;
      // Remove extra spaces
      text = text.replace(/\s+/g, ' ');
      // Split into sentences
      let splitted = text.split(/(?<=[.?!„ÄÇÔºÅÔºü])/).map(s => s.trim()).filter(Boolean);
      // Join back with blank lines
      textarea.value = splitted.join('\n\n');
      updatePreview();
    }, 50);
  });
});

async function checkApiKey() {
  let key = localStorage.getItem('openai_api_key');
  if (!key) {
    key = prompt("Please enter your OpenAI API key (saved locally):");
    if (key) localStorage.setItem('openai_api_key', key);
    else alert("API key is required to use TTS.");
  }
}

function resetApiKey() {
  localStorage.removeItem('openai_api_key');
  checkApiKey();
}

function updatePreview() {
  const text = document.getElementById('inputText').value;
  // Split by empty lines or by sentence-ending punctuation
  sentences = text.split(/\n\s*\n|(?<=[.?!„ÄÇÔºÅÔºü])/).map(s => s.trim()).filter(Boolean);
  const preview = document.getElementById('preview');
  preview.innerHTML = sentences.map((s, idx) =>
    `<span class="sentence" data-idx="${idx}">${s}</span>`
  ).join('');
  preview.querySelectorAll('.sentence').forEach(span => {
    span.addEventListener('click', () => {
      currentIndex = parseInt(span.dataset.idx);
      highlightCurrent();
      playSentence(currentIndex);
    });
  });
  cache = {};  // clear cache when text changes
  currentIndex = 0;
  highlightCurrent();
}

function highlightCurrent() {
  const spans = document.querySelectorAll('.sentence');
  spans.forEach(span => span.classList.remove('active'));
  if (spans[currentIndex]) spans[currentIndex].classList.add('active');
}

async function playSentence(idx) {
  if (cache[idx]) {
    // play cached audio
    const audio = new Audio(cache[idx]);
    audio.play();
  } else {
    // call OpenAI & cache
    const text = sentences[idx];
    const apiKey = localStorage.getItem('openai_api_key');
    if (!apiKey) return alert("Missing API key.");
    try {
      const res = await fetch("https://api.openai.com/v1/audio/speech", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + apiKey,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "tts-1",
          voice: "alloy",
          input: text
        })
      });
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        alert("OpenAI Error: " + (errorData.error?.message || res.statusText));
        return;
      }
      const arrayBuffer = await res.arrayBuffer();
      const blob = new Blob([arrayBuffer], { type: "audio/mpeg" });
      const url = URL.createObjectURL(blob);
      cache[idx] = url;
      const audio = new Audio(url);
      audio.play();
    } catch (e) {
      console.error(e);
      alert("Failed to speak.");
    }
  }
}

function playCurrent() {
  if (sentences.length === 0) return;
  highlightCurrent();
  playSentence(currentIndex);
}

function playPrevious() {
  if (sentences.length === 0) return;
  currentIndex = Math.max(0, currentIndex - 1);
  highlightCurrent();
  playSentence(currentIndex);
}

function playNext() {
  if (sentences.length === 0) return;
  currentIndex = Math.min(sentences.length - 1, currentIndex + 1);
  highlightCurrent();
  playSentence(currentIndex);
}
</script>
</body>
</html>
